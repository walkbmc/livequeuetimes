{"version":3,"sources":["../../lib/merlinparks/chessingtonworldofadventures.js"],"names":["MerlinPark","require","crypto","Moment","cheerio","rideNames","ParseArea","obj","areas","i","AddRideName","items","j","isRide","categories","category","id","name","__dirname","ChessingtonWorldOfAdventures","options","timezone","latitude","longitude","api_base","api_key","resort_id","challenge","createHash","update","APIKey","digest","ridedata","FetchOpeningTimesHTML","then","HTML","ParseOpeningTimesHTML","HTTP","url","$","load","each","idx","el","hasClass","hours","dayinfo","find","text","opens","attr","closes","toLowerCase","indexOf","Schedule","SetDate","openingTime","closingTime","type","Promise","resolve","module","exports"],"mappings":"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","file":"chessingtonworldofadventures.js","sourcesContent":["\"use strict\";\r\n\r\nvar MerlinPark = require(\"./legacy\");\r\nvar crypto = require(\"crypto\");\r\nvar Moment = require(\"moment-timezone\");\r\n\r\n// web-scraping library for opening dates\r\nvar cheerio = require(\"cheerio\");\r\n\r\n// grab JSON park data\r\nvar rideNames = {};\r\n\r\n// parse ride names from manually extracted JSON file\r\nfunction ParseArea(obj) {\r\n    if (!obj) return;\r\n\r\n    if (obj.areas) {\r\n        for (var i in obj.areas) {\r\n            AddRideName(obj.areas[i]);\r\n            ParseArea(obj.areas[i]);\r\n        }\r\n    }\r\n\r\n    if (obj.items) {\r\n        for (var j in obj.items) {\r\n            AddRideName(obj.items[j]);\r\n            ParseArea(obj.items[j]);\r\n        }\r\n    }\r\n\r\n}\r\n\r\nfunction AddRideName(obj) {\r\n    // check this is a ride before storing it's name\r\n    var isRide = false;\r\n    if (obj.categories) {\r\n        for (var i = 0, category; category = obj.categories[i++];) {\r\n            // rides and attractions have category ID 465\r\n            if (category == 465) {\r\n                isRide = true;\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (isRide) {\r\n        rideNames[obj.id] = obj.name;\r\n    }\r\n}\r\n\r\nParseArea(require(__dirname + \"/chessingtonworldofadventures_data.js\").areas);\r\n\r\n// edge-case: this ride is actually missing from the app, add it manually\r\nif (!rideNames[3958]) {\r\n    rideNames[3958] = \"Penguins of Madagascar Mission: Treetop Hoppers\";\r\n}\r\n\r\n/**\r\n * Chessington World Of Adventures\r\n * @class\r\n * @extends MerlinPark\r\n */\r\nclass ChessingtonWorldOfAdventures extends MerlinPark {\r\n    /**\r\n     * Create a new ChessingtonWorldOfAdventures object\r\n     */\r\n    constructor(options = {}) {\r\n        options.name = options.name || \"Chessington World Of Adventures\";\r\n        options.timezone = options.timezone || \"Europe/London\";\r\n\r\n        // set park's location as it's entrance\r\n        options.latitude = options.latitude || 51.3496;\r\n        options.longitude = options.longitude || -0.31457;\r\n\r\n        // Park API options\r\n        options.api_base = \"https://legacy-api.attractions.io/apps/command/chessington\";\r\n        options.api_key = \"edqXyMWFtuqGY6BZ9Epkzg4ptqe6v3c7tdqa97VbXjvrgZHC\";\r\n\r\n        options.resort_id = 44;\r\n\r\n        // inherit from base class\r\n        super(options);\r\n\r\n    }\r\n\r\n    /**\r\n     * Response to challenge request for Chessington World Of Adventures API\r\n     */\r\n    _APIRespond(challenge) {\r\n        // this is actually identical to Alton Towers, but the challenge and API Key are swapped around\r\n        return crypto.createHash(\"md5\").update(challenge + this.APIKey).digest(\"hex\");\r\n    }\r\n\r\n    /**\r\n     * Given a ride object, return the ride's name\r\n     */\r\n    _GetRideName(ridedata) {\r\n        return rideNames[ridedata.id];\r\n    }\r\n\r\n    FetchOpeningTimes() {\r\n        return this.FetchOpeningTimesHTML().then((HTML) => {\r\n            return this.ParseOpeningTimesHTML(HTML);\r\n        });\r\n    }\r\n\r\n    FetchOpeningTimesHTML() {\r\n        return this.HTTP({\r\n            url: \"https://www.chessington.com/plan/chessington-opening-times.aspx\"\r\n        });\r\n    }\r\n\r\n    ParseOpeningTimesHTML(HTML) {\r\n        var $ = cheerio.load(HTML);\r\n\r\n        $(\".day\").each((idx, el) => {\r\n            el = $(el);\r\n            // skip days in the pass\r\n            if (el.hasClass(\"inactive\")) return;\r\n\r\n            var hours = {\r\n                dayinfo: el.find(\".dayInfo > span\").text(),\r\n                opens: el.find(\"meta[itemprop=opens]\").attr(\"content\"),\r\n                closes: el.find(\"meta[itemprop=closes]\").attr(\"content\"),\r\n            };\r\n\r\n            // check if the park is open this day (and not just the zoo or such)\r\n            var dayinfo = hours.dayinfo ? hours.dayinfo.toLowerCase() : \"\";\r\n            // normal opening day\r\n            if (dayinfo.indexOf(\"theme park\") >= 0) {\r\n                this.Schedule.SetDate({\r\n                    openingTime: Moment(hours.opens),\r\n                    closingTime: Moment(hours.closes),\r\n                    type: \"Operating\"\r\n                });\r\n            }\r\n        });\r\n\r\n        return Promise.resolve();\r\n    }\r\n}\r\n\r\nmodule.exports = ChessingtonWorldOfAdventures;"]}