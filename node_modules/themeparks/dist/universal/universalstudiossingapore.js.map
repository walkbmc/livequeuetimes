{"version":3,"sources":["../../lib/universal/universalstudiossingapore.js"],"names":["Park","require","GeoLocation","cheerio","Moment","s_APIBase","Symbol","s_APILanguage","s_parkLocationMin","s_parkLocationMax","s_parkScheduleURL","UniversalStudiosSingapore","options","name","latitude","longitude","timezone","api_base","api_langauge","schedule_url","Promise","resolve","reject","randomGeoLocation","RandomBetween","Log","HTTP","url","body","LatitudeRaw","LongitudeRaw","then","ResponseOfUSS","Result","USSZoneList","USSZone","forEach","zone","rides","Content","USSContent","rideIDX","ride","rideObject","GetRideObject","id","USSContentID","Name","WaitTime","Availability","parseInt","QueueTime","ParseOpeningHoursHTML","bind","results","dateIdx","date","Schedule","SetDate","OpeningHour","openingTime","closingTime","ClosingHour","HTML","$","load","tables","tableIdx","table","month","find","text","isValid","dates","i","dateString","dateVal","dateHours","last","trim","replace","match","exec","tz","Timezone","push","module","exports"],"mappings":"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","file":"universalstudiossingapore.js","sourcesContent":["// include core Park class\r\nconst Park = require(\"../park\");\r\n\r\nconst GeoLocation = require(\"../geoLocation\");\r\n\r\nconst cheerio = require(\"cheerio\");\r\nconst Moment = require(\"moment-timezone\");\r\n\r\nconst s_APIBase = Symbol();\r\nconst s_APILanguage = Symbol();\r\nconst s_parkLocationMin = Symbol();\r\nconst s_parkLocationMax = Symbol();\r\nconst s_parkScheduleURL = Symbol();\r\n\r\n/**\r\n * Implements the Universal Singapore API.\r\n * @class\r\n * @extends Park\r\n */\r\nclass UniversalStudiosSingapore extends Park {\r\n    /**\r\n     * Create new UniversalStudiosSingapore Object.\r\n     * @param {Object} options\r\n     * @param {String} [options.api_base] API URL base for accessing API\r\n     * @param {String} [options.api_langauge] Language ID for API results (default: 1)\r\n     */\r\n    constructor(options = {}) {\r\n        options.name = options.name || \"Universal Studios Singapore\";\r\n\r\n        // set park's location as it's entrance\r\n        options.latitude = options.latitude || 1.254251;\r\n        options.longitude = options.longitude || 103.823797;\r\n\r\n        options.timezone = \"Asia/Singapore\";\r\n\r\n        // inherit from base class\r\n        super(options);\r\n\r\n        this[s_APIBase] = options.api_base || \"http://cma.rwsentosa.com/Service.svc/GetUSSContent\";\r\n        this[s_APILanguage] = options.api_langauge || 1;\r\n        this[s_parkScheduleURL] = options.schedule_url || \"http://www.rwsentosa.com/Homepage/Attractions/UniversalStudiosSingapore\";\r\n\r\n        // Geofence corners (to generate random location for API requests)\r\n        this[s_parkLocationMin] = new GeoLocation({\r\n            latitude: 1.2547872658731591,\r\n            longitude: 103.8217341899872\r\n        });\r\n        this[s_parkLocationMax] = new GeoLocation({\r\n            latitude: 1.2533177673892697,\r\n            longitude: 103.82408380508424\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Fetch Universal Singapore's waiting times\r\n     * @returns {Promise}\r\n     */\r\n    FetchWaitTimes() {\r\n        return new Promise((resolve, reject) => {\r\n            // generate random geo location to fetch with\r\n            const randomGeoLocation = GeoLocation.RandomBetween(this[s_parkLocationMin], this[s_parkLocationMax]);\r\n\r\n            this.Log(\"Running Universal Studios Singapore\");\r\n            this.HTTP({\r\n                url: this[s_APIBase],\r\n                body: {\r\n                    \"languageID\": this[s_APILanguage],\r\n                    \"filter\": \"Ride\",\r\n                    \"Latitude\": randomGeoLocation.LatitudeRaw,\r\n                    \"Longitude\": randomGeoLocation.LongitudeRaw\r\n                },\r\n            }).then((body) => {\r\n                // check the response is as we expect\r\n                if (!body || !body.ResponseOfUSS || !body.ResponseOfUSS.Result || !body.ResponseOfUSS.Result.USSZoneList || !body.ResponseOfUSS.Result.USSZoneList.USSZone) {\r\n                    this.Log(`Error parsing Universal Studios Singapore response: ${body}`);\r\n                    return reject(\"Unable to parse Universal Studios Singapore wait times response\");\r\n                }\r\n\r\n                // loop through each zone\r\n                body.ResponseOfUSS.Result.USSZoneList.USSZone.forEach((zone) => {\r\n                    var rides = zone.Content.USSContent;\r\n\r\n                    // loop through each ride\r\n                    for (var rideIDX = 0, ride; ride = rides[rideIDX++];) {\r\n                        var rideObject = this.GetRideObject({\r\n                            id: ride.USSContentID,\r\n                            name: ride.Name\r\n                        });\r\n\r\n                        rideObject.WaitTime = (ride.Availability && ride.Availability == \"True\") ? parseInt(ride.QueueTime, 10) || -1 : -1;\r\n                    }\r\n                });\r\n\r\n                return resolve();\r\n            }, reject);\r\n        });\r\n    }\r\n\r\n    FetchOpeningTimes() {\r\n        // Get HTML page of park\r\n        return this.HTTP({\r\n            url: this[s_parkScheduleURL]\r\n        }).then(this.ParseOpeningHoursHTML.bind(this)).then((results) => { // parse results\r\n            for (var dateIdx = 0, date; date = results[dateIdx++];) {\r\n                // record results\r\n                this.Schedule.SetDate({\r\n                    date: date.OpeningHour,\r\n                    openingTime: date.OpeningHour,\r\n                    closingTime: date.ClosingHour\r\n                });\r\n            }\r\n            return Promise.resolve();\r\n        });\r\n    }\r\n\r\n    ParseOpeningHoursHTML(HTML) {\r\n        var $ = cheerio.load(HTML);\r\n\r\n        var results = [];\r\n\r\n        // grab all the styled tables (a potential calendar)\r\n        var tables = $(\"table.styled\");\r\n        for (var tableIdx = 0, table; table = tables[tableIdx++];) {\r\n            table = $(table);\r\n            // check we found a calendar month (otherwise it's some other table on this page)\r\n            const month = table.find(\".tableTitle\").text();\r\n            // validate using Moment\r\n            if (Moment(month, \"MMMM YYYY\").isValid()) {\r\n                // find each table cell\r\n                const dates = table.find(\"td\");\r\n                for (var i = 0, date; date = dates[i++];) {\r\n                    date = $(date);\r\n                    // check it has a valid date (and not an empty cell!)\r\n                    const dateString = date.find(\"strong\").text();\r\n                    const dateVal = parseInt(dateString, 10);\r\n                    if (dateVal > 0) {\r\n                        // slim down hours to remove all whitespace\r\n                        //  leave in newlines, so we can ignore the special parades/hours\r\n                        const dateHours = date.find(\"span\").last().text().trim().replace(/[^\\S\\n]/g, \"\");\r\n\r\n                        // look for valid times\r\n                        var match = /([0-9]+[AP]M)-([0-9]+[AP]M)/.exec(dateHours);\r\n                        if (match && match[1] && match[2]) {\r\n                            const OpeningHour = Moment.tz(`${dateVal} ${month} ${match[1]}`, \"D MMMM YYYY HA\", this.Timezone);\r\n                            const ClosingHour = Moment.tz(`${dateVal} ${month} ${match[2]}`, \"D MMMM YYYY HA\", this.Timezone);\r\n\r\n                            results.push({\r\n                                OpeningHour,\r\n                                ClosingHour\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return Promise.resolve(results);\r\n    }\r\n}\r\n\r\n// export the class\r\nmodule.exports = UniversalStudiosSingapore;"]}