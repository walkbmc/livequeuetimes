{"version":3,"sources":["../../lib/universal/index.js"],"names":["Park","require","Moment","crypto","api_baseURL","api_appKey","api_appSecret","s_parkID","Symbol","s_city","UniversalPark","options","name","scheduleDaysToReturn","park_id","Error","park_city","receivedTtl","Cache","Wrap","Promise","resolve","reject","today","utc","format","signatureBuilder","createHmac","update","signature","digest","replace","HTTP","url","method","headers","Date","body","apiKey","then","Token","Log","toString","expireyDate","TokenExpirationString","now","diff","bind","err","requestObject","GetAccessToken","access_token","Accept","GetAPIUrl","data","city","Rides","i","ride","VenueId","rideObject","GetRideObject","id","Id","MblDisplayName","WaitTime","FastPass","ExpressPassAccepted","hoursEndDate","add","endDate","length","day","Schedule","SetDate","openingTime","tz","OpenTimeString","Timezone","closingTime","CloseTimeString","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["\"use strict\";\r\n\r\n// include core Park class\r\nvar Park = require(\"../park\");\r\nvar Moment = require(\"moment-timezone\");\r\n\r\n// crypto lib for generating access token signature\r\nvar crypto = require(\"crypto\");\r\n\r\n// API settings\r\nvar api_baseURL = \"https://services.universalorlando.com/api/\";\r\nvar api_appKey = \"AndroidMobileApp\";\r\nvar api_appSecret = \"AndroidMobileAppSecretKey182014\";\r\n\r\nvar s_parkID = Symbol();\r\nvar s_city = Symbol();\r\n\r\n// park IDs:\r\n//  Studios: 10010\r\n//  Islands: 10000\r\n//  CityWalk: 10011\r\n//  Wet 'N Wild: 45084\r\n\r\n/**\r\n * Implements the Universal API framework. All Universal parks use this one API.\r\n * @class\r\n * @extends Park\r\n */\r\nclass UniversalPark extends Park {\r\n    /**\r\n     * Create new UniversalPark Object.\r\n     * This object should not be called directly, but rather extended for each of the individual Universal parks\r\n     * @param {Object} options\r\n     * @param {String} options.park_id Universal API park ID\r\n     */\r\n    constructor(options = {}) {\r\n        options.name = options.name || \"Universal Park\";\r\n\r\n        // Universal parks return lots of opening time data, return a few months of data by default\r\n        options.scheduleDaysToReturn = options.scheduleDaysToReturn || 90;\r\n\r\n        // inherit from base class\r\n        super(options);\r\n\r\n        // grab Universal API configs for this park instance\r\n        if (!options.park_id) throw new Error(\"Missing park's API ID\");\r\n        this[s_parkID] = options.park_id;\r\n\r\n        // universal hollywood uses ?city= on it's API requests, so optionally support setting that\r\n        this[s_city] = options.park_city;\r\n    }\r\n\r\n    // override Fastpass Getter to declare support for FastPass\r\n    get FastPass() {\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Get our current access token\r\n     * @returns {Promise}\r\n     */\r\n    GetAccessToken() {\r\n        var receivedTtl;\r\n\r\n        return this.Cache.Wrap(\"accesstoken\", function() {\r\n            return new Promise(function(resolve, reject) {\r\n                // Get access token\r\n                // generate access token signature\r\n                //  calculate current date to generate access token signature\r\n                var today = Moment.utc().format(\"ddd, DD MMM YYYY HH:mm:ss\") + \" GMT\";\r\n\r\n                // create signature to get access token\r\n                var signatureBuilder = crypto.createHmac(\"sha256\", api_appSecret);\r\n                signatureBuilder.update(api_appKey + \"\\n\" + today + \"\\n\");\r\n                // generate hash from signature builder\r\n                //  also convert trailing equal signs to unicode. because. I don't know\r\n                var signature = signatureBuilder.digest(\"base64\").replace(/=$/, \"\\u003d\");\r\n\r\n                // request new access token\r\n                this.HTTP({\r\n                    url: api_baseURL,\r\n                    method: \"POST\",\r\n                    headers: {\r\n                        Date: today\r\n                    },\r\n                    body: {\r\n                        apiKey: api_appKey,\r\n                        signature: signature,\r\n                    }\r\n                }).then(\r\n                    function(body) {\r\n                        // check we actually got the token back\r\n                        if (!body.Token) {\r\n                            this.Log(body.toString(\"ascii\"));\r\n                            return reject(\"Missing access token from Universal API\");\r\n                        }\r\n\r\n                        var expireyDate = Moment(body.TokenExpirationString, \"YYYY-MM-DDTHH:mm:ssZ\");\r\n                        var now = Moment();\r\n                        // expire this access token a minute before the API says (just to be sure)\r\n                        receivedTtl = expireyDate.diff(now, \"seconds\") - 60;\r\n\r\n                        // resolve with our new access token (Wrap will cache for us)\r\n                        resolve(body.Token);\r\n                    }.bind(this),\r\n                    function(err) {\r\n                        this.Log(\"Error fetching Universal Access Token: \" + err);\r\n                        return reject(err);\r\n                    }.bind(this)\r\n                );\r\n            }.bind(this));\r\n        }.bind(this), function() {\r\n            // Ttl callback setter\r\n            return receivedTtl;\r\n        }.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Fetch a URL from the Universal API\r\n     */\r\n    GetAPIUrl(requestObject) {\r\n        return this.GetAccessToken().then(function(access_token) {\r\n            // make sure headers exist if they weren't set already\r\n            if (!requestObject.headers) requestObject.headers = [];\r\n            requestObject.headers.Accept = \"application/json\";\r\n            requestObject.headers[\"Content-Type\"] = \"application/json; charset=UTF-8\";\r\n            requestObject.headers[\"Accept-Language\"] = \"en-US\";\r\n\r\n            // add our access token to the request\r\n            if (access_token) {\r\n                requestObject.headers[\"X-UNIWebService-ApiKey\"] = api_appKey;\r\n                requestObject.headers[\"X-UNIWebService-Token\"] = access_token;\r\n            }\r\n\r\n            // send network request\r\n            return this.HTTP(requestObject);\r\n        }.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Fetch this Universal Park's waiting times\r\n     * @returns {Promise}\r\n     */\r\n    FetchWaitTimes() {\r\n        return new Promise(function(resolve, reject) {\r\n            // ride wait time data is kept in the pointsOfInterest URL\r\n            this.GetAPIUrl({\r\n                url: api_baseURL + \"pointsOfInterest\",\r\n                data: this[s_city] ? {\r\n                    city: this[s_city]\r\n                } : null\r\n            }).then(function(body) {\r\n                if (!body || !body.Rides) return reject(\"Universal POI data missing Rides array\");\r\n\r\n                for (var i = 0, ride; ride = body.Rides[i++];) {\r\n                    // skip if this ride isn't for our current park\r\n                    // TODO - store poiData separately for both parks to access\r\n                    if (ride.VenueId != this[s_parkID]) continue;\r\n\r\n                    // waitTimes assumed key:\r\n                    //  -1 seems to mean \"closed\"\r\n                    //  -2 means \"delayed\", which I guess is a nice way of saying \"broken\"\r\n                    //  -3 and -50 seems to mean planned closure\r\n\r\n                    // find/create this ride\r\n                    var rideObject = this.GetRideObject({\r\n                        id: ride.Id,\r\n                        name: ride.MblDisplayName\r\n                    });\r\n\r\n                    // update wait time\r\n                    rideObject.WaitTime = ride.WaitTime;\r\n                    // update FastPass status\r\n                    rideObject.FastPass = ride.ExpressPassAccepted;\r\n                }\r\n\r\n                resolve();\r\n            }.bind(this), reject);\r\n        }.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Fetch this Universal Park's opening times\r\n     * @returns {Promise}\r\n     */\r\n    FetchOpeningTimes() {\r\n        return new Promise(function(resolve, reject) {\r\n            // pick a date 1 month from now (in middle/lowest/highest form MM/DD/YYYY, because I don't know)\r\n            var hoursEndDate = Moment().add(12, \"months\").format(\"MM/DD/YYYY\");\r\n\r\n            this.GetAPIUrl({\r\n                url: api_baseURL + `venues/${this[s_parkID]}/hours`,\r\n                data: {\r\n                    endDate: hoursEndDate,\r\n                    city: this[s_city] ? this[s_city] : null\r\n                }\r\n            }).then(function(body) {\r\n                if (!body || !body.length) return reject(\"No venue hour data found from Universal API\");\r\n\r\n                // find all published opening times for the next year and insert into our schedule\r\n                for (var i = 0, day; day = body[i++];) {\r\n                    this.Schedule.SetDate({\r\n                        // for ease, we'll just parse the Unix timestamp\r\n                        openingTime: Moment.tz(day.OpenTimeString, \"YYYY-MM-DDTHH:mm:ssZ\", this.Timezone),\r\n                        closingTime: Moment.tz(day.CloseTimeString, \"YYYY-MM-DDTHH:mm:ssZ\", this.Timezone)\r\n                    });\r\n                }\r\n\r\n                resolve();\r\n            }.bind(this), reject);\r\n        }.bind(this));\r\n    }\r\n}\r\n\r\n// export the class\r\nmodule.exports = UniversalPark;"]}